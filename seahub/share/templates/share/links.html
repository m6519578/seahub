{% extends 'home_base.html' %}
{% load seahub_tags i18n %}
{% load url from future %}

{% block sub_title %}{% trans "Links - Share" %} - {% endblock %}

{% block cur_share_links %}tab-cur{% endblock %}

{% block right_panel %}
<div id="tabs" class="tab-tabs">
    <ul class="tab-tabs-nav hd w100 ovhd">
        <li class="tab"><a href="#download-links" class="a">{% trans "Download Links" %}</a></li>
        <li class="tab long-tab"><a href="#upload-links" class="a">{% trans "Upload Links" %}</a></li>
    </ul>
    <div id="download-links">
        {% if fileshares %}
        <table>
            <tr>
                <th width="4%"><!--icon--></th>
                <th width="20%" class="by-name cspt">{% trans "Name"%} <span class="sort-icon hide"></span></th>
                <th width="24%">{% trans "Library"%}</th>
                <th width="20%">{% trans "Status"%}</th>
                <th width="10%">{% trans "Visits"%}</th>
                <th width="12%" class="by-time cspt">{% trans "Expiration"%} <span class="sort-icon hide"></span></th>
                <th width="10%"><!--Operations--></th>
            </tr>
            {% for fs in fileshares %}
            <tr data-type="{{fs.s_type}}" data-name="{{ fs.filename }}" data-time="{{ fs.expire_date|date:'Y-m-d' }}">
                {% if fs.s_type == 'f' %}
                <td class="alc"><img src="{{ MEDIA_URL }}img/file/{{ fs.filename|file_icon_filter }}" alt="{% trans "File"%}" /></td>
                <td><a href="{% url 'view_lib_file' fs.repo.id fs.path %}">{{ fs.filename }}</a></td>
                {% else %}
                <td class="alc"><img src="{{ MEDIA_URL }}img/folder-24.png" alt="{% trans "Directory icon"%}" /></td>
                <td><a href="{% url 'view_common_lib_dir' fs.repo.id fs.path|strip_slash %}">{{ fs.filename }}</a></td>
                {% endif %}
                <td><a href="{% url 'view_common_lib_dir' fs.repo.id '' %}">{{ fs.repo.name }}</a></td>
                <td>
                    <a href="#" class="stats" data-token="{{fs.token}}">{{ fs.get_short_status_str }}</a>
                    {% if fs.need_remind %}<button class="js-remind" data-token="{{fs.token}}">{% trans "remind" %}</button>{% endif %}
                </td>
                {% if fs.pass_verify %}
                <td>{{ fs.view_cnt }}</td>
                {% else %}
                <td>--</td>
                {% endif %}
                {% if fs.pass_verify and fs.expire_date %}
                <td {%if fs.is_expired%}class='error'{%endif%}>{{ fs.expire_date|date:'Y-m-d' }}</td>
                {% else %}
                <td>--</td>
                {% endif %}
                <td>
                    <a href="#" class="sf2-icon-delete rm-link op-icon vh" data-token="{{ fs.token }}" title="{% trans "Remove"%}"></a>
                </td>
            </tr>
            {% endfor %}
        </table>
        {% else %}
        <div class="empty-tips">
            <h2 class="alc">{% trans "You don't have any download link"%}</h2>
            <p>{% trans "You can generate a download link for a folder or a file. People receive this link can view the folder or the file online." %}</p>
        </div>
        {% endif %}
    </div>

    <div id="upload-links" class="hide">
        {% if uploadlinks %}
        <table>
            <tr>
                <th width="4%"><!--icon--></th>
                <th width="34%">{% trans "Name"%}</th>
                <th width="25%">{% trans "Library"%}</th>
                <th width="14%">{% trans "Password"%}</th>
                <th width="8%">{% trans "Visits"%}</th>
                <th width="15%">{% trans "Operations"%}</th>
            </tr>
            {% for link in uploadlinks %}
            <tr>
                <td class="alc"><img src="{{ MEDIA_URL }}img/folder-24.png" alt="{% trans "Directory icon"%}" /></td>
                <td><a href="{% url 'view_common_lib_dir' link.repo.id link.path|strip_slash %}">{{ link.dir_name }}</a></td>
                <td><a href="{% url 'view_common_lib_dir' link.repo.id '' %}">{{ link.repo.name }}</a></td>
                {% with pwd=link.get_decoded_password %}
                {% if pwd %}
                <td>{{ pwd }}</td>
                {% else %}
                <td>--</td>
                {% endif %}
                {% endwith %}                
                <td>{{ link.view_cnt }}</td>
                <td>
                    <a href="#" class="sf2-icon-link view-link op-icon vh" data-link="{{ link.shared_link }}" title="{% trans "View"%}"></a>
                    <a href="#" class="sf2-icon-delete rm-upload-link op-icon vh" data-token="{{ link.token }}" title="{% trans "Remove"%}"></a>
                </td>
            </tr>
            {% endfor %}
        </table>
        {% else %}
        <div class="empty-tips">
            <h2 class="alc">{% trans "You don't have any upload link"%}</h2>
            <p>{% trans "You can generate an upload link from any folder. People receive this link can upload files to this folder." %}</p>
        </div>
        {% endif %}
    </div>
</div>
<input type="text" readonly="readonly" value="" id="shared-link" class="hide" />
<div id="shared-link-stats" class="hide">
    <span class="loading-icon loading-tip"></span>
</div>
{% endblock %}

{% block extra_script %}{{block.super}}
{% if fileshares %}
<script type="text/javascript" src="{{MEDIA_URL}}js/ChinesePinYinInitials.js"></script>
{% endif %}
<script type="text/javascript">
{% if fileshares or uploadlinks %}
$(".view-link").click(function() {
    var link = $(this).attr('data-link');
    $('#shared-link').before('<p class="hide">' + link + '</p>')
    .val(link).css('width', $('#shared-link').prev().width() + 2)
    .modal({focus:false});
    $('#shared-link').prev().remove();

    return false;
});

// rm download/upload link
$('.rm-link, .rm-upload-link').click(function() {
    var _this = $(this);
    $.ajax({
        url: $(this).hasClass('rm-link') ? '{% url 'ajax_remove_shared_link' %}' : '{% url 'ajax_remove_shared_upload_link' %}',
        type: 'POST',
        data: {'t': $(this).attr('data-token')},
        cache: false,
        dataType: 'json',
        beforeSend: prepareCSRFToken,
        success: function() {
            _this.closest('tr').remove();
        },
        error: ajaxErrorHandler
    });

    return false;
});

$('#shared-link').click(function() {
    $(this).select();
});

{% comment "Start PingAn Group related" %}{% endcomment %}
$('.stats').click(function() {
    var $container = $('#shared-link-stats');
    var token = $(this).attr('data-token');

    $container.css({'width':600, 'height':300, 'overflow':'auto'}).modal();

    $.ajax({
        url: '{% url "ajax_get_link_status" %}',
        data: {'token': token},
        cache: false,
        dataType: 'json',
        success: function(data) {
            var str = '';
            for (var i = 0, len = data.status.length; i < len; i++) {
                str += '<li>' + HTMLescape(data.status[i]) + '</li>';
            }
            $container.html('<ul>' + str + '</ul>');

            if (data.pass_verify) {
                str = '<p>该文件下载链接已通过 ' + '{{email_host_user|escapejs}}' + '外发至邮箱: ' + HTMLescape(data.receivers.join(', ')) + ' (发送于' + data.sent_at + ')</p>';
                str += '<p>密码： ' + data.password + '</p>';
                str += '<button id="re-send-link" style="margin-right:10px;">重新发送</button><span class="loading-icon vam" style="display:none;"></span><span id="re-send-link-result" class="hide"></span>';

                $container.append(str);

                $('#re-send-link').click(function() {
                    var $btn = $(this);
                    var $loadingIcon = $btn.next('.loading-icon').show();
                    var $result = $('#re-send-link-result').hide();

                    disable($btn);
                    $.ajax({
                        url: '{% url "ajax_email_link_receivers" %}',
                        data: {'token': token},
                        cache: false,
                        dataType: 'json',
                        success: function(data) {
                            $result.html('发送成功').addClass('success').show();
                        },
                        error: function(xhr) {
                            var msg;
                            try {
                                msg = $.parseJSON(xhr.responseText).error;
                            }
                            catch(e) {
                                msg = '发送失败';
                            }
                            $result.html(msg).addClass('error').show();
                        },
                        complete: function() {
                            $loadingIcon.hide();
                            enable($btn);
                        }
                    });
                });
            }
        },
        error: function(xhr) {
            var msg;
            if (xhr.responseText) {
                msg = $.parseJSON(xhr.responseText).error;
            } else {
                msg = "{% trans "Failed. Please check the network." %}";
            }
            $container.html('<p class="error">' + msg + '</p>');
        }
    });

    return false;
});

$('.js-remind').click(function() {
    var token = $(this).attr('data-token');
    $.ajax({
        url: "{% url 'ajax_remind_revisers' %}",
        type: 'POST',
        data: {
            'token': token
        },
        cache: false,
        dataType: 'json',
        beforeSend: prepareCSRFToken,
        success: function(data) {
            if (data.sent.length > 0) {
                feedback("{% trans 'Successfully sent email to: ' %}" + data.sent.join(', '), 'success');
            } else {
                feedback("{% trans 'Success' %}", 'success');
            }
        },
        error: ajaxErrorHandler
    });

    return false;
});
{% comment "End PingAn Group related" %}{% endcomment %}

{% endif %}

{% if fileshares %}
// sort download links
$('.by-name, .by-time').click(function() {
    var $table = $(this).closest('table');

    // handle sort-icon
    $('.sort-icon', $table).hide();
    var $sort_icon = $('.sort-icon', $(this)).show();
    if ($sort_icon.hasClass('icon-caret-up') ||
        $sort_icon.hasClass('icon-caret-down')) {
        $sort_icon.toggleClass('icon-caret-up icon-caret-down');
    } else {
        $sort_icon.addClass('icon-caret-up');
    }

    // prepare data
    var dir_item_list = [],
        file_item_list = [],
        $items = $('tr:gt(0)', $table);
    $items.each(function(index, item) {
        var obj = {
            'element': item,
            'name': $(item).attr('data-name'),
            'time': $(item).attr('data-time')
        };
        if ($(item).data('type') == 'd') {
            dir_item_list.push(obj);
        } else {
            file_item_list.push(obj);
        }
    });

    // define 'sort by' functions
    var by_name_up = function (a, b) {
        var a_name_code = a.name.charCodeAt(0); // get the first character code from a.name
        var b_name_code = b.name.charCodeAt(0);
        if ((a_name_code >= 19968 && a_name_code <= 40869) &&
            (b_name_code >= 19968 && b_name_code <= 40869)) {
            var a_name_pinyin = ChinesePinYinInitials.charAt(a_name_code - 19968); // get the first letter of the name's first charater's pinyin
            var b_name_pinyin = ChinesePinYinInitials.charAt(b_name_code - 19968);
            if (a_name_pinyin == b_name_pinyin) {
                return 0;
            } else {
                return a_name_pinyin < b_name_pinyin ? -1 : 1;
            }

        } else {
            return a.name.toLowerCase() < b.name.toLowerCase() ? -1 : 1;
        }
    };
    var by_name_down = function (a, b) {
        var a_name_code = a.name.charCodeAt(0); // get the first character code from a.name
        var b_name_code = b.name.charCodeAt(0);
        if ((a_name_code >= 19968 && a_name_code <= 40869) &&
            (b_name_code >= 19968 && b_name_code <= 40869)) {
            var a_name_pinyin = ChinesePinYinInitials.charAt(a_name_code - 19968); // get the first letter of the name's first charater's pinyin
            var b_name_pinyin = ChinesePinYinInitials.charAt(b_name_code - 19968);
            if (a_name_pinyin == b_name_pinyin) {
                return 0;
            } else {
                return a_name_pinyin < b_name_pinyin ? 1 : -1;
            }

        } else {
            return a.name.toLowerCase() < b.name.toLowerCase() ? 1 : -1;
        }
    };
    var by_time_up = function (a, b) {
        if (!a.time && !b.time) {
            return 0;
        }
        if (!a.time && b.time) {
            return 1;
        }
        if (a.time && !b.time) {
            return -1;
        }
        return a.time < b.time ? -1 : 1;
    };
    var by_time_down = function (a, b) {
        if (!a.time && !b.time) {
            return 0;
        }
        if (!a.time && b.time) {
            return -1;
        }
        if (a.time && !b.time) {
            return 1;
        }
        return a.time < b.time ? 1 : -1;
    };

    // sort
    if ($(this).hasClass('by-name')) {
        // by name
        if ($sort_icon.hasClass('icon-caret-up')) {
            dir_item_list.sort(by_name_up);
            file_item_list.sort(by_name_up);
        } else {
            dir_item_list.sort(by_name_down);
            file_item_list.sort(by_name_down);
        }
    } else {
        // by time
        if ($sort_icon.hasClass('icon-caret-up')) {
            dir_item_list.sort(by_time_up);
            file_item_list.sort(by_time_up);
        } else {
            dir_item_list.sort(by_time_down);
            file_item_list.sort(by_time_down);
        }
    }

    // DOM op
    $items.detach();
    $(dir_item_list).each(function(index, item) {
        $table.append(item.element);
    });
    $(file_item_list).each(function(index, item) {
        $table.append(item.element);
    });
});
{% endif %}
</script>
{% endblock %}
